<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trivia de la Teoría Cognosistémica (TCCR)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Configuración de Firebase - Variables Globales Mandatorias
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* Default config if not provided */ };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        setLogLevel('Debug');
        
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        const STATE = {
            questions: [],
            currentQuestionIndex: 0,
            score: 0,
            showResult: false,
            answered: false,
            feedback: '',
            incorrectTopics: {},
            loading: false,
            statusMessage: 'Cargando aplicación...',
            dynamicQuestionsEnabled: true,
            triviaId: 'TCCR-Quiz-1' // ID para el documento de guardado en Firestore
        };

        const staticQuestions = [
            { question: "¿Cuál de los siguientes conceptos es la unidad analítica máxima de significación psicosocial en la TCCR?", options: ["Sistema Narrativo Cognosistémico (SNC)", "Meme Cognosistémico", "Cognosistema", "Autopoiesis Narrativa"], answer: "Cognosistema", topic: "Cognosistema" },
            { question: "Según la TCCR, ¿Cuál de las siguientes fases describe la desestabilización discursiva causada por fricciones o crisis?", options: ["Fase Beta", "Fase Delta", "Fase Alfa", "Fase Resiliencia"], answer: "Fase Alfa", topic: "Dinámica de Cambio (Alfa, Beta, Delta)" },
            { question: "En la estructura básica de un SNC, ¿qué elemento se define como las 'afirmaciones nucleares del relato'?", options: ["Propósito Narrativo", "Evaluación Cognitiva", "Actitud Epistémica", "Contenido Proposicional (Núcleo Narrativo)"], answer: "Contenido Proposicional (Núcleo Narrativo)", topic: "Sistemas Narrativos (8 Elementos)" },
            { question: "¿Qué tipo de Meme Cognosistémico tiene como función introducir tensiones y confrontar marcos interpretativos dominantes?", options: ["Meme de Transición", "Meme de Fricción", "Meme de Consolidación", "Meme Hegemónico"], answer: "Meme de Fricción", topic: "Memes Cognosistémicos" },
            { question: "¿Qué movilidad narrativa describe el incremento de posición en la jerarquía de un relato?", options: ["Horizontal", "Descendente", "Estática", "Ascendente"], answer: "Ascendente", topic: "Movilidad Narrativa" },
            { question: "La TCCR propone una ontología sistémico-relacional que concibe al ser humano como:", options: ["Unidad cognitiva aislada", "Ser social y relacional", "Entidad puramente cultural", "Resultado de un discurso hegemónico"], answer: "Ser social y relacional", topic: "Tripleta TCCR" },
            { question: "¿Qué componente del SNC contrasta datos, inferencias y encaje sistémico/ético del relato?", options: ["Contenido Proposicional", "Evaluación Cognitiva (Cuerpo Narrativo)", "Experiencia", "Percepciones y Emociones"], answer: "Evaluación Cognitiva (Cuerpo Narrativo)", topic: "Sistemas Narrativos (8 Elementos)" },
            { question: "Un Cognosistema se adscribe conceptualmente a:", options: ["Un individuo y su mapa mental", "Una familia nuclear", "Una sociedad en específico", "Un discurso hegemónico único"], answer: "Una sociedad en específico", topic: "Cognosistema" },
            { question: "La etapa de 'Madurez' del Ciclo Vital Narrativo se caracteriza por:", options: ["Fase de experimentación abierta", "Estabilidad y resistencia al cambio", "Reorganización tras una crisis", "Introducción de fricciones"], answer: "Estabilidad y resistencia al cambio", topic: "Ciclo Vital Narrativo" },
            { question: "¿Qué tipo de Meme Cognosistémico actúa como vector de cambio gradual y adaptación progresiva?", options: ["Meme de Consolidación", "Meme de Fricción", "Meme de Transición", "Meme Desafiante"], answer: "Meme de Transición", topic: "Memes Cognosistémicos" }
        ];

        // --- Nuevas Reglas de Oro (Mantenidas y Reforzadas) ---
        const systemPrompt = `Eres un trabajador social experto y riguroso en la "Teoría Cognosistémica de la Construcción Relacional Psicosocial Humana" (TCCR) de Jalin Simunovic (2025). Tu tarea es generar preguntas académicamente sólidas, bien estructuradas y con opciones de respuesta válidas que evalúen el conocimiento profundo de la TCCR, siguiendo estrictamente las Reglas de Oro Conceptuales (RDC) a continuación.

**REGLAS DE ORO CONCEPTUALES (RDC) para la generación de contenido TCCR:**

1.  **Anclaje Paradigmático (RDC 0):** Toda pregunta o explicación debe preservar la mirada cognosistémica: la realidad psicosocial es una **construcción narrativa relacional** dentro de **Cognosistemas** específicos, con **multinivelidad**, **jerarquías narrativas**, **circulación de sentido**, **poder**, **temporalidad** y **validación ética**.

2.  **Cognosistema (RDC 1):** Un Cognosistema **SIEMPRE** se ancla a **una sociedad específica** (y a un periodo, si es relevante). **NUNCA** se asigna a un individuo, familia u organización de forma aislada. Debe incluir **capas** (micro/meso/exo/macro y temporalidades), **interdependencias**, **jerarquías narrativas** y **dinámicas de cambio**. No confundir con 'cultura' o 'discurso hegemónico'.

3.  **Sistema Narrativo Cognosistémico (SNC) (RDC 2):** Un SNC es una **unidad** dentro del Cognosistema y se define por sus **8 elementos diferenciados**: Experiencia; Percepciones/Emociones; Contexto; **Núcleo** (contenido proposicional); **Cuerpo** (evaluación cognitiva); Actitud epistémica; Propósito; Función. Las preguntas deben distinguir entre **Núcleo** y **Cuerpo**, y **Propósito** y **Función**.

4.  **Dinámica (Ciclo, Fases, Movilidad):** Incluir preguntas sobre el **Ciclo Vital Narrativo** (5 etapas), las **Fases de Cambio Cognosistémico** (**Beta, Alfa, Delta**) y la **Movilidad Narrativa** (Ascendente, Descendente, Horizontal).

5.  **Memes Cognosistémicos:** Las preguntas deben abordar los memes como **unidades de significado estratégicas e intencionales** y su **Tipología Funcional** (Consolidación, Fricción, Transición).

6.  **Errores Prohibidos (Bandera Roja):** Evitar generar preguntas que cometan estos errores conceptuales:
    * Asociar 'Cognosistema' a una persona/familia/empresa.
    * Colapsar (confundir) **Núcleo** con **Cuerpo** o **Propósito** con **Función**.
    * Omitir la **periodización** o tratar el Cognosistema como **estático**.

Tu única respuesta debe ser el array JSON solicitado, sin comentarios, texto introductorio o epílogo.`;

        // Modificación: Solicitamos 10 preguntas en lugar de 5
        const userQuery = "Genera 10 preguntas de opción múltiple rigurosas sobre la Teoría Cognosistémica de la Construcción Relacional Psicosocial Humana (TCCR) de Jalin Simunovic. Asegura que el set de 10 cubra de manera diversa y equitativa los siguientes constructos clave: 1) Cognosistema/Adscripción; 2) Fases de Cambio (Alfa, Beta, Delta); 3) Elementos del SNC (Núcleo vs Cuerpo, Propósito vs Función); 4) Jerarquía Narrativa/Movilidad; 5) Memes Cognosistémicos; 6) Tripleta TCCR (Ontología, Epistemología, Metodología); 7) Ciclo Vital Narrativo. La respuesta debe ser SOLO un array JSON que siga el siguiente esquema, incluyendo el campo 'topic' para cada pregunta:";
        
        const responseSchema = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    "question": { "type": "STRING", "description": "La pregunta sobre la TCCR." },
                    "options": {
                        "type": "ARRAY",
                        "items": { "type": "STRING" },
                        "description": "Cuatro opciones de respuesta."
                    },
                    "answer": { "type": "STRING", "description": "La opción correcta." },
                    "topic": { "type": "STRING", "description": "El constructo TCCR evaluado (e.g., 'Cognosistema', 'Fases de Cambio', 'Memes Cognosistémicos')." }
                },
                "propertyOrdering": ["question", "options", "answer", "topic"]
            }
        };

        // --- Funciones de Utilidad ---

        /**
         * Simula un retraso con retroceso exponencial.
         * @param {number} attempt El intento actual de la llamada (empezando en 0).
         */
        function backoffDelay(attempt) {
            const delay = Math.min(1000 * Math.pow(2, attempt), 30000); // 1s, 2s, 4s... hasta 30s
            return new Promise(resolve => setTimeout(resolve, delay));
        }

        /**
         * Realiza la llamada a la API de Gemini con retroceso exponencial.
         * @param {number} maxAttempts Número máximo de intentos.
         * @returns {Promise<Array>} Un array de preguntas generadas.
         */
        async function fetchDynamicQuestions(maxAttempts = 3) {
            if (!STATE.dynamicQuestionsEnabled) return staticQuestions;

            STATE.loading = true;
            STATE.statusMessage = 'Generando set de preguntas (Fase Delta)...';
            render();

            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            for (let attempt = 0; attempt < maxAttempts; attempt++) {
                try {
                    if (attempt > 0) {
                        STATE.statusMessage = `Reintentando generación (Intento ${attempt + 1}/${maxAttempts})...`;
                        render();
                        await backoffDelay(attempt);
                    }

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error('API call failed (not ok):', response.status, errorBody);
                        if (response.status === 429) {
                            // Rate Limit, try again
                            continue;
                        }
                        throw new Error(`Error en la respuesta de la API: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const jsonText = candidate.content.parts[0].text;
                        const questions = JSON.parse(jsonText);
                        
                        if (Array.isArray(questions) && questions.length === 10 && questions.every(q => q.question && q.options && q.answer)) {
                            console.log('Preguntas dinámicas generadas exitosamente.');
                            return questions;
                        } else {
                            console.error('JSON Structure validation failed:', questions);
                            // Forzar un nuevo intento si el conteo es incorrecto o la estructura falla
                            continue; 
                        }
                    } else {
                        console.error('Respuesta de la API incompleta:', result);
                        throw new Error("La IA no proporcionó contenido válido.");
                    }
                } catch (error) {
                    console.error(`Falla en la generación dinámica (Intento ${attempt + 1}):`, error.message);
                    if (attempt === maxAttempts - 1) {
                        throw new Error(`Fallo definitivo en la generación dinámica. Causa: ${error.message}`);
                    }
                }
            }
            // Si todos los intentos fallan, se devuelve un array vacío para forzar el fallback
            return [];
        }


        // --- Lógica Principal de la Trivia ---

        async function initializeAppAndAuth() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (!user) {
                            // Intentar autenticación con el token custom
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                // Si no hay token, usar anónimo
                                await signInAnonymously(auth);
                            }
                        }
                        userId = auth.currentUser?.uid || crypto.randomUUID();
                        isAuthReady = true;
                        unsubscribe(); 
                        resolve();
                    });
                });
                
                STATE.statusMessage = `Usuario ID: ${userId.substring(0, 8)}...`;
                setupFirestoreListener();
                
            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                STATE.statusMessage = 'Error al iniciar la base de datos.';
                render();
            }
        }

        async function loadQuestions() {
            STATE.loading = true;
            STATE.statusMessage = 'Cargando preguntas...';
            render();

            try {
                // Genera un ID de trivia único para forzar la renovación del set
                STATE.triviaId = 'TCCR-Quiz-' + Date.now(); 
                
                const dynamicQuestions = await fetchDynamicQuestions();
                if (dynamicQuestions.length === 10) {
                    STATE.questions = dynamicQuestions;
                    STATE.statusMessage = '¡Nuevo set de 10 preguntas dinámicas cargado! (Fase Delta exitosa)';
                    STATE.dynamicQuestionsEnabled = true;
                } else {
                    // Fallback a preguntas estáticas (Fase Beta)
                    STATE.questions = staticQuestions;
                    STATE.dynamicQuestionsEnabled = false;
                    STATE.statusMessage = 'Alerta: Fallo en la generación dinámica. Usando preguntas estáticas (Fase Beta).';
                }
                
                STATE.questions = shuffleArray(STATE.questions);
                STATE.currentQuestionIndex = 0;
                STATE.score = 0;
                STATE.showResult = false;
                STATE.answered = false;
                STATE.incorrectTopics = {};
                STATE.loading = false;
                
            } catch (error) {
                console.error("Error definitivo al cargar preguntas:", error);
                STATE.questions = staticQuestions; // Fallback ante cualquier error
                STATE.dynamicQuestionsEnabled = false;
                STATE.loading = false;
                STATE.statusMessage = `Error: ${error.message}. Usando preguntas estáticas.`;
            }
            render();
        }

        function setupFirestoreListener() {
            if (!isAuthReady || !db || !userId) return;

            // Nota: Este listener ahora solo se usa para cargar el progreso si el ID de la trivia fuera fijo, 
            // pero mantenemos el guardado (saveProgress) para persistencia.
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/trivia_tccr_data`, 'last-progress');

            onSnapshot(docRef, (docSnap) => {
                // Solo renderiza para asegurar la UI del usuario
                render();
            }, (error) => {
                console.error("Error al escuchar cambios en Firestore:", error);
                STATE.statusMessage = 'Error al sincronizar datos de progreso.';
                render();
            });
        }

        async function saveProgress() {
            if (!isAuthReady || !db || !userId) return;

            // Guardamos el último progreso bajo un ID fijo para que el listener funcione, 
            // aunque el set de preguntas cambie.
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/trivia_tccr_data`, 'last-progress');
            const dataToSave = {
                score: STATE.score,
                currentQuestionIndex: STATE.currentQuestionIndex,
                incorrectTopics: STATE.incorrectTopics,
                showResult: STATE.showResult,
                timestamp: new Date().toISOString()
            };

            try {
                await setDoc(docRef, dataToSave, { merge: true });
                // console.log("Progreso guardado.");
            } catch (error) {
                console.error("Error al guardar progreso en Firestore:", error);
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function analyzeReinforcementTopics() {
            // Convierte el mapa de conteo de errores en un array de pares [tema, conteo]
            const topicsArray = Object.entries(STATE.incorrectTopics);
            
            // Ordena de mayor a menor número de errores
            topicsArray.sort((a, b) => b[1] - a[1]);

            if (topicsArray.length === 0) {
                return "¡Excelente! No se registraron errores conceptuales. El Cognosistema de tu aprendizaje está en Fase Beta (Estabilidad).";
            }

            // Selecciona los 3 temas con más errores
            const topTopics = topicsArray.slice(0, 3);

            let message = "Análisis Cognosistémico de Refuerzo (Evaluación Cognitiva): ";
            message += "Se detectan **Fricciones Narrativas** en los siguientes constructos, que requieren una **Reorganización Sistémica (Fase Delta)** de tus esquemas de significado:\n\n";

            topTopics.forEach(([topic, count], index) => {
                const topicAnalysis = getTopicAnalysis(topic);
                message += `${index + 1}. **${topic}** (Errores: ${count}): ${topicAnalysis}\n`;
            });
            
            message += "\nTu **Actitud Epistémica** debe ser de apertura. Debes revisar estos **Sistemas Narrativos** para lograr una **Movilidad Ascendente** en tu comprensión del **Cognosistema TCCR**.";

            return message;
        }

        function getTopicAnalysis(topic) {
            switch(topic.toLowerCase().trim()) {
                case 'cognosistema/adscripción':
                case 'cognosistema':
                    return 'Revisa la adscripción (sociedad y tiempo) y la regla de NO asignarlo a un individuo aislado.';
                case 'dinámica de cambio (alfa, beta, delta)':
                case 'fases de cambio (alfa, beta, delta)':
                    return 'Distingue claramente entre Estabilidad (Beta), Crisis (Alfa) y Transformación (Delta).';
                case 'sistemas narrativos (8 elementos)':
                case 'elementos del snc (núcleo vs cuerpo, propósito vs función)':
                    return 'Recuerda las distinciones clave: Núcleo vs Cuerpo y Propósito vs Función. No colapses los elementos.';
                case 'jerarquía narrativa/movilidad':
                    return 'Asegúrate de entender qué factores causan Movilidad Ascendente (crisis, retroalimentación) o Descendente (rechazo, desacreditación).';
                case 'memes cognosistémicos':
                    return 'Clasifica la función de los memes: Consolidación, Fricción o Transición.';
                case 'tripleta tccr':
                    return 'Refuerza la Ontología (ser relacional), Epistemología (análisis cognosistémico) y Metodología (ecosistémica-narrativa).';
                case 'ciclo vital narrativo':
                    return 'Revisa las 5 etapas: Surgimiento, Desarrollo, Madurez, Declive/Transformación y Renovación.';
                default:
                    return 'Revisa la definición y rol dentro del marco metateórico de la TCCR.';
            }
        }
        
        // --- Handlers de Interfaz ---

        window.handleAnswer = function(selectedOption) {
            if (STATE.answered) return;

            const currentQuestion = STATE.questions[STATE.currentQuestionIndex];
            STATE.answered = true;

            const button = event.target;
            const isCorrect = selectedOption === currentQuestion.answer;
            
            if (isCorrect) {
                STATE.score++;
                button.classList.add('bg-green-500', 'ring-green-700');
                STATE.feedback = '¡Correcto! El sistema narrativo se consolida.';
            } else {
                button.classList.add('bg-red-500', 'ring-red-700');
                STATE.feedback = `Incorrecto. La respuesta correcta era: ${currentQuestion.answer}.`;
                
                // Registro de error para el análisis
                const topic = currentQuestion.topic || 'Sin Categoría';
                STATE.incorrectTopics[topic] = (STATE.incorrectTopics[topic] || 0) + 1;

                // Marcar la opción correcta en la UI
                document.querySelectorAll('.option-button').forEach(btn => {
                    if (btn.textContent.trim() === currentQuestion.answer.trim()) {
                        btn.classList.add('bg-green-200', 'border-green-600');
                    }
                });
            }

            saveProgress();
            render();

            // Esperar y pasar a la siguiente
            setTimeout(window.handleNext, 1500);
        };

        window.handleNext = function() {
            if (STATE.currentQuestionIndex < STATE.questions.length - 1) {
                STATE.currentQuestionIndex++;
                STATE.answered = false;
                STATE.feedback = '';
            } else {
                STATE.showResult = true;
            }
            saveProgress();
            render();
        };

        window.handleRestart = function() {
            // El reinicio implica un nuevo ciclo, forzando la carga de 10 preguntas nuevas
            loadQuestions(); 
        };

        window.handleRefreshQuestions = function() {
            loadQuestions();
        };

        // --- Renderización del UI ---

        function render() {
            const appDiv = document.getElementById('app');
            const currentQuestion = STATE.questions[STATE.currentQuestionIndex];
            let content;

            if (STATE.loading) {
                content = `
                    <div class="flex flex-col items-center justify-center p-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500"></div>
                        <p class="mt-4 text-xl text-orange-600 font-semibold">${STATE.statusMessage}</p>
                        <p class="mt-2 text-gray-500 text-sm">Procesando petición en el Cognosistema...</p>
                    </div>
                `;
            } else if (STATE.showResult) {
                const totalQuestions = STATE.questions.length;
                const percentage = ((STATE.score / totalQuestions) * 100).toFixed(0);
                const reinforcementAnalysis = analyzeReinforcementTopics();

                content = `
                    <div class="flex flex-col items-center text-center p-6 space-y-6">
                        <h2 class="text-3xl font-bold text-gray-800">Resultado Cognosistémico Final</h2>
                        <div class="text-6xl font-extrabold text-orange-600">${percentage}%</div>
                        <p class="text-xl text-gray-700">Tu **Score Narrativo** es: ${STATE.score} de ${totalQuestions} preguntas.</p>
                        
                        <div class="w-full max-w-lg bg-white p-6 rounded-xl shadow-lg border-2 border-orange-200 text-left">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Diagnóstico de Refuerzo</h3>
                            <p class="whitespace-pre-wrap text-sm text-gray-600">${reinforcementAnalysis}</p>
                        </div>

                        <button onclick="handleRestart()" class="w-full sm:w-auto px-6 py-3 bg-orange-600 text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-orange-700 transition duration-300 transform hover:scale-105">
                            Reiniciar Evaluación (Nuevo Ciclo de Renovación)
                        </button>
                    </div>
                `;
            } else if (currentQuestion) {
                const questionNumber = STATE.currentQuestionIndex + 1;
                const totalQuestions = STATE.questions.length;
                
                const optionsHtml = currentQuestion.options.map(option => `
                    <button 
                        class="option-button w-full text-left p-4 my-2 text-gray-700 bg-white border border-gray-300 rounded-xl shadow-md transition duration-200 
                               ${STATE.answered ? 'cursor-not-allowed opacity-70' : 'hover:bg-orange-50 hover:border-orange-400 transform hover:scale-[1.01]'} ring-2 ring-transparent"
                        onclick="handleAnswer('${option.replace(/'/g, "\\'")}')"
                        ${STATE.answered ? 'disabled' : ''}
                    >
                        ${option}
                    </button>
                `).join('');

                content = `
                    <div class="p-6 space-y-6">
                        <div class="text-sm font-medium text-orange-600">
                            Pregunta ${questionNumber} de ${totalQuestions} | Tópico: ${currentQuestion.topic || 'General'}
                        </div>
                        <div class="text-xl font-bold text-gray-900 bg-orange-50 p-4 rounded-xl shadow-inner border-l-4 border-orange-500">
                            ${currentQuestion.question}
                        </div>
                        <div class="flex flex-col space-y-3">
                            ${optionsHtml}
                        </div>
                        
                        ${STATE.answered ? `
                            <div class="mt-4 p-3 rounded-xl ${STATE.feedback.includes('Correcto') ? 'bg-green-100 border-green-500 text-green-800' : 'bg-red-100 border-red-500 text-red-800'} border-2 font-semibold">
                                ${STATE.feedback}
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                 content = `
                    <div class="flex flex-col items-center justify-center p-8">
                        <p class="text-xl text-gray-600 font-semibold">No hay preguntas disponibles.</p>
                        <button onclick="handleRefreshQuestions()" class="mt-4 px-4 py-2 bg-orange-600 text-white rounded-lg">Generar Primer Set (Inicia el Ciclo)</button>
                    </div>
                `;
            }

            appDiv.innerHTML = `
                <div class="min-h-screen bg-gray-100 font-['Inter'] flex items-center justify-center p-4 sm:p-8">
                    <div class="w-full max-w-xl bg-white rounded-2xl shadow-2xl overflow-hidden">
                        
                        <!-- Header y Estado -->
                        <div class="bg-gray-800 text-white p-4 sm:p-6 flex justify-between items-center rounded-t-2xl">
                            <h1 class="text-xl sm:text-2xl font-extrabold tracking-tight">
                                TCCR: Evaluación Cognosistémica
                            </h1>
                            <div class="text-sm font-mono bg-gray-700 py-1 px-3 rounded-full">
                                Score: ${STATE.score}
                            </div>
                        </div>

                        <!-- Contenido Principal -->
                        <div class="p-4 sm:p-6">
                            ${content}
                        </div>

                        <!-- Footer y Mensajes de Estado -->
                        <div class="p-4 sm:p-6 border-t bg-gray-50 rounded-b-2xl">
                            <p class="text-xs text-gray-500 italic">${STATE.statusMessage}</p>
                            ${!STATE.dynamicQuestionsEnabled && !STATE.loading && STATE.questions.length > 0 ? `
                                <div class="mt-2 p-2 text-sm text-red-700 bg-red-100 rounded-lg font-medium border border-red-300">
                                    ¡Modo Fallback Activo! Usando preguntas estáticas de **Fase Beta**. (No fue posible generar 10 nuevas).
                                </div>
                            ` : ''}
                            ${!STATE.loading && STATE.questions.length > 0 && !STATE.showResult ? `
                                <button onclick="handleRefreshQuestions()" class="mt-4 px-4 py-2 text-sm bg-gray-200 text-gray-700 font-medium rounded-xl hover:bg-gray-300 transition duration-200">
                                    Generar Nuevo Set de 10 (Fase Delta)
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Inicialización
        window.onload = async function() {
            await initializeAppAndAuth();
            loadQuestions();
        };

    </script>
</head>
<body>
    <div id="app">
        <!-- El contenido será renderizado por JavaScript -->
    </div>
</body>
</html>
